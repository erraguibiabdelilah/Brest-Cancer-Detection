
<div class="upload-container">
  <!-- Navigation -->
  <nav>
    <div class="nav-content">
      <div class="logo">
        <img src="logo2.png" width="60px" height="60px" alt="">
        <span style="color: black;">Breast</span> <span style="color: rgb(1, 1, 110);">Care</span>
      </div>
      <ul class="nav-links">
        <li><a routerLink="/">Accueil</a></li>
        <li><a routerLink="/upload">Analyser</a></li>
        <li><a routerLink="/history">Historique</a></li>
        <li *ngIf="currentUser" class="user-info">
          <span class="user-name">{{ currentUser.name || currentUser.email }}</span>
          <button class="btn-logout" (click)="logout()">D√©connexion</button>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <div class="page-header">
      <h2>Nouvelle Analyse</h2>
      <p>T√©l√©versez une image histopathologique pour une analyse par IA</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section" *ngIf="!selectedFile && !result">
      <div 
        class="upload-area" 
        [class.dragover]="false"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()"
      >
        <div class="upload-icon">üìÅ</div>
        <h3>T√©l√©verser une image m√©dicale</h3>
        <p>Glissez-d√©posez votre image ici, ou cliquez pour parcourir</p>
        <input 
          type="file" 
          #fileInput
          id="fileInput" 
          class="file-input" 
          accept="image/*"
          (change)="onFileSelected($event)"
        >
        <button class="btn-upload" type="button">
          Choisir un fichier
        </button>
        <div class="file-types">Formats support√©s : JPEG, PNG</div>
      </div>
      <div class="error-message" *ngIf="error">
        <div class="error-content" [innerHTML]="error.replace(/\n/g, '<br>')"></div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" *ngIf="selectedFile && !result && !isUploading">
      <div class="preview-header">
        <h3>Aper√ßu de l'image</h3>
        <button class="btn-remove" (click)="reset()">Supprimer</button>
      </div>
      <div class="preview-content">
        <div class="image-preview">
          <img [src]="previewUrl" alt="Preview" id="imagePreview">
        </div>
        <div class="image-info">
          <div class="info-card">
            <div class="info-label">Nom du fichier</div>
            <div class="info-value">{{ selectedFile?.name || '-' }}</div>
          </div>
          <div class="info-card">
            <div class="info-label">Taille</div>
            <div class="info-value">{{ selectedFile ? getFileSize(selectedFile.size) : '-' }}</div>
          </div>
          <div class="info-card">
            <div class="info-label">Dimensions</div>
            <div class="info-value" *ngIf="imageDimensions">{{ imageDimensions }}</div>
            <div class="info-value" *ngIf="!imageDimensions">Calcul...</div>
          </div>
          <button class="btn-analyze" (click)="uploadImage()" [disabled]="isUploading">
            D√©marrer l'analyse
          </button>
        </div>
      </div>
    </div>

    <!-- Analysis Progress -->
    <div class="analysis-progress" *ngIf="isUploading">
      <div class="progress-icon">‚ö°</div>
      <h3>Analyse en cours...</h3>
      <p>L'intelligence artificielle analyse votre image</p>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressPercent"></div>
      </div>
      <div class="progress-meta">
        <div class="progress-percentage">{{ progressPercent | number:'1.0-0' }}%</div>
        <div class="progress-text">{{ loadingMessage }}</div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" *ngIf="result">
      <!-- Header with Download Button -->
      <div class="results-header-card">
        <div class="results-header-content">
          <h2>R√©sultats de l'analyse</h2>
          <div class="analysis-date">{{ getCurrentDate() }}</div>
        </div>
        <button class="btn-download" (click)="generateMedicalReport()">
          <span class="download-icon"><img src="dowload.png" 
           width="30px" height="30px" color="white" alt=""></span>
          T√©l√©charger le rapport
        </button>
      </div>

      <!-- Results Grid -->
      <div class="results-grid">
        <div class="result-card primary" [class.positive]="isPositive()" [class.negative]="!isPositive()">
          <div class="result-icon">{{ isPositive() ? '‚ö†Ô∏è' : '‚úÖ' }}</div>
          <div class="result-label">R√©sultat Global</div>
          <div class="result-value" [class.success]="!isPositive()" [class.warning]="isPositive()">
            {{ isPositive() ? 'POSITIF' : 'N√âGATIF' }}
          </div>
          <div class="result-description">{{ result.label }}</div>
        </div>
        
        <div class="result-card">
          <div class="result-icon">üìä</div>
          <div class="result-label">Score de confiance</div>
          <div class="result-value">{{ getConfidencePercentage() }}%</div>
          <div class="result-description">Fiabilit√© de l'analyse</div>
        </div>
        
        <div class="result-card">
          <div class="result-icon">‚è±Ô∏è</div>
          <div class="result-label">Temps de traitement</div>
          <div class="result-value">{{ processingTime }}</div>
          <div class="result-description">Dur√©e de l'analyse</div>
        </div>

        <div class="result-card">
          <div class="result-icon">üÜî</div>
          <div class="result-label">ID Patient</div>
          <div class="result-value">{{ patientId }}</div>
          <div class="result-description">Identifiant unique</div>
        </div>

        <div class="result-card">
          <div class="result-icon">üî¨</div>
          <div class="result-label">Type d'examen</div>
          <div class="result-value-small">{{ imageType }}</div>
          <div class="result-description">{{ modelVersion }}</div>
        </div>

        <div class="result-card">
          <div class="result-icon">üìê</div>
          <div class="result-label">Dimensions</div>
          <div class="result-value-small">{{ imageDimensions }}</div>
          <div class="result-description">R√©solution de l'image</div>
        </div>
      </div>

      <!-- Detailed Findings -->
      <div class="detailed-results">
        <h3>R√©sultats d√©taill√©s</h3>
        <ul class="findings-list">
          <li class="finding-item">
            <div class="finding-header">
              <span class="finding-title">D√©tection IDC (Carcinome canalaire invasif)</span>
              <span class="confidence-badge">{{ getConfidencePercentage() }}% Confiance</span>
            </div>
            <div class="finding-description">
              {{ isPositive() 
                ? 'Carcinome canalaire invasif (IDC) d√©tect√© dans l\'√©chantillon de tissu analys√©. Le mod√®le a identifi√© des irr√©gularit√©s tissulaires, une densit√© anormale et des patterns typiques des cellules canc√©reuses. Une consultation m√©dicale imm√©diate est recommand√©e pour confirmer le diagnostic et √©tablir un plan de traitement appropri√©.' 
                : 'Aucun signe de carcinome canalaire invasif (IDC) d√©tect√©. Le tissu appara√Æt normal selon les param√®tres d\'analyse du mod√®le. Les structures observ√©es correspondent √† des tissus sains. Un suivi m√©dical r√©gulier reste n√©anmoins recommand√© selon les recommandations de votre m√©decin.' }}
            </div>
          </li>
        </ul>
      </div>

      <!-- Medical Recommendation -->
      <div class="recommendation-box" [class.warning]="isPositive()" [class.info]="!isPositive()">
        <h3>
          <span class="recommendation-icon">{{ isPositive() ? '' : '‚úì' }}</span>
          Recommandation m√©dicale
        </h3>
        <p>
          {{ isPositive()
            ? '‚ö†Ô∏è IMPORTANT : Ce r√©sultat sugg√®re la pr√©sence d\'anomalies n√©cessitant une attention m√©dicale imm√©diate. Veuillez consulter un oncologue ou un radiologue qualifi√© dans les plus brefs d√©lais pour effectuer des examens compl√©mentaires (biopsie, analyses approfondies) et √©tablir un diagnostic d√©finitif. Cette analyse IA est un outil d\'aide √† la d√©cision et ne remplace pas un examen m√©dical professionnel.'
            : '‚úì Ce r√©sultat est rassurant mais ne remplace pas un suivi m√©dical r√©gulier. Continuez vos contr√¥les p√©riodiques selon les recommandations de votre m√©decin. En cas d\'apparition de sympt√¥mes inhabituels, consultez imm√©diatement un professionnel de sant√©. La d√©tection pr√©coce reste essentielle pour une prise en charge optimale.' }}
        </p>
      </div>

      <!-- Legal Warning -->
      <div class="legal-warning">
        <h3> Avertissement l√©gal</h3>
        <p>
          Ce syst√®me est un outil d'aide √† la d√©cision m√©dicale et <strong>ne remplace EN AUCUN CAS</strong> l'avis d'un professionnel de sant√© qualifi√©. 
          Ce r√©sultat doit √™tre interpr√©t√© par un m√©decin comp√©tent. Un diagnostic d√©finitif n√©cessite un examen clinique complet. 
          L'exactitude du mod√®le IA peut varier selon la qualit√© de l'image. La confidentialit√© des donn√©es patient est strictement prot√©g√©e.
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn-secondary" (click)="reset()">Nouvelle analyse</button>
        <button class="btn-primary" (click)="generateMedicalReport()">
          <span class="download-icon"><img src="dowload.png" 
           width="30px" height="30px" color="white" alt=""></span>
        
          T√©l√©charger le rapport complet
        </button>
      </div>
    </div>
  </div>
</div>
